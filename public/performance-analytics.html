<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Analytics & KPIs - IRTOMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 25px;
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .kpi-card h2 {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .kpi-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .kpi-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .kpi-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .trend-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }
        
        .trend-up { color: #28a745; }
        .trend-down { color: #dc3545; }
        .trend-stable { color: #6c757d; }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .audit-entry {
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
        }
        
        .audit-entry.success { border-left-color: #28a745; }
        .audit-entry.warning { border-left-color: #ffc107; }
        .audit-entry.error { border-left-color: #dc3545; }
    </style>
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin.html">
                <i class="fas fa-chart-bar"></i>
                Performance Analytics & KPIs
            </a>
            
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-user-shield"></i>
                    <span id="adminName">Administrator</span>
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <!-- Time Range Selector -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5><i class="fas fa-calendar-alt"></i> Analysis Period</h5>
                            </div>
                            <div class="col-md-6">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-primary active" onclick="setTimeRange('24h')">24 Hours</button>
                                    <button class="btn btn-outline-primary" onclick="setTimeRange('7d')">7 Days</button>
                                    <button class="btn btn-outline-primary" onclick="setTimeRange('30d')">30 Days</button>
                                    <button class="btn btn-outline-primary" onclick="setTimeRange('90d')">90 Days</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Performance Indicators -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="kpi-card success">
                    <h2 id="throughputKPI">87.3%</h2>
                    <p>System Throughput</p>
                    <div class="trend-indicator">
                        <i class="fas fa-arrow-up trend-up me-2"></i>
                        <span>+5.2% from last period</span>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="kpi-card info">
                    <h2 id="punctualityKPI">94.1%</h2>
                    <p>On-time Performance</p>
                    <div class="trend-indicator">
                        <i class="fas fa-arrow-up trend-up me-2"></i>
                        <span>+2.8% improvement</span>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="kpi-card warning">
                    <h2 id="delayKPI">4.2</h2>
                    <p>Avg Delay (minutes)</p>
                    <div class="trend-indicator">
                        <i class="fas fa-arrow-down trend-up me-2"></i>
                        <span>-1.5 min reduced</span>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="kpi-card">
                    <h2 id="aiAccuracyKPI">96.7%</h2>
                    <p>AI Prediction Accuracy</p>
                    <div class="trend-indicator">
                        <i class="fas fa-minus trend-stable me-2"></i>
                        <span>Stable</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Charts -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Throughput Trend Analysis</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="throughputTrendChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-clock"></i> Punctuality Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="punctualityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Analytics -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-robot"></i> AI Performance Analysis</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="aiPerformanceChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-exclamation-triangle"></i> Conflict Resolution</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <div style="width: 150px; height: 150px; margin: 0 auto; position: relative;">
                                <canvas id="conflictResolutionChart"></canvas>
                            </div>
                        </div>
                        <div class="row text-center">
                            <div class="col-4">
                                <h4 class="text-success">42</h4>
                                <small>Prevented</small>
                            </div>
                            <div class="col-4">
                                <h4 class="text-info">18</h4>
                                <small>Resolved</small>
                            </div>
                            <div class="col-4">
                                <h4 class="text-warning">2</h4>
                                <small>Pending</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Performance Comparison -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-map-marked-alt"></i> Section Performance Comparison</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Section</th>
                                        <th>Throughput</th>
                                        <th>Punctuality</th>
                                        <th>Utilization</th>
                                        <th>AI Optimizations</th>
                                        <th>Status</th>
                                        <th>Performance Score</th>
                                    </tr>
                                </thead>
                                <tbody id="sectionPerformanceTable">
                                    <tr>
                                        <td><strong>Delhi-Mumbai Section A</strong></td>
                                        <td><span class="badge bg-success">92%</span></td>
                                        <td><span class="badge bg-success">96%</span></td>
                                        <td><span class="badge bg-info">78%</span></td>
                                        <td>247</td>
                                        <td><i class="fas fa-check-circle text-success"></i> Excellent</td>
                                        <td><div class="progress" style="width: 100px;"><div class="progress-bar bg-success" style="width: 92%"></div></div></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Mumbai-Pune Section B</strong></td>
                                        <td><span class="badge bg-warning">76%</span></td>
                                        <td><span class="badge bg-warning">89%</span></td>
                                        <td><span class="badge bg-success">82%</span></td>
                                        <td>189</td>
                                        <td><i class="fas fa-exclamation-triangle text-warning"></i> Good</td>
                                        <td><div class="progress" style="width: 100px;"><div class="progress-bar bg-warning" style="width: 76%"></div></div></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Chennai-Bangalore Corridor</strong></td>
                                        <td><span class="badge bg-success">88%</span></td>
                                        <td><span class="badge bg-success">94%</span></td>
                                        <td><span class="badge bg-info">75%</span></td>
                                        <td>203</td>
                                        <td><i class="fas fa-check-circle text-success"></i> Excellent</td>
                                        <td><div class="progress" style="width: 100px;"><div class="progress-bar bg-success" style="width: 88%"></div></div></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audit Trail -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-history"></i> Recent System Activities</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadFullAuditTrail()">
                            View Full Audit Trail
                        </button>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="auditTrailContainer">
                            <!-- Audit entries will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/js/auth.js"></script>
    
    <script>
        let currentTimeRange = '24h';
        let charts = {};
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check admin authentication
            if (!window.authManager.requireRole('admin')) {
                return;
            }
            
            // Set admin name
            const user = window.authManager.getUser();
            document.getElementById('adminName').textContent = user.fullName || 'Administrator';
            
            // Initialize dashboard
            initializeAnalytics();
            loadPerformanceData();
            loadAuditTrail();
        });
        
        async function initializeAnalytics() {
            try {
                // Initialize charts
                initializeThroughputTrendChart();
                initializePunctualityChart();
                initializeAIPerformanceChart();
                initializeConflictResolutionChart();
                
                console.log('Analytics dashboard initialized');
                
            } catch (error) {
                console.error('Analytics initialization error:', error);
                showNotification('Failed to initialize analytics dashboard', 'error');
            }
        }
        
        async function loadPerformanceData() {
            try {
                const response = await window.authManager.makeAuthenticatedRequest(
                    `/api/traffic-control/performance-metrics?timeRange=${currentTimeRange}`
                );
                
                if (response) {
                    const data = await response.json();
                    updatePerformanceMetrics(data.data);
                }
                
            } catch (error) {
                console.error('Performance data loading error:', error);
                showNotification('Failed to load performance data', 'error');
            }
        }
        
        function updatePerformanceMetrics(data) {
            // Update KPI cards
            if (data.throughput) {
                document.getElementById('throughputKPI').textContent = data.throughput.trainsProcessed + '%';
            }
            if (data.punctuality) {
                document.getElementById('punctualityKPI').textContent = data.punctuality.onTimePercentage + '%';
            }
            if (data.punctuality) {
                document.getElementById('delayKPI').textContent = data.punctuality.averageDelay;
            }
            if (data.aiPerformance) {
                document.getElementById('aiAccuracyKPI').textContent = data.aiPerformance.recommendationAccuracy + '%';
            }
            
            // Update charts with real data
            updateChartsWithData(data);
        }
        
        function initializeThroughputTrendChart() {
            const ctx = document.getElementById('throughputTrendChart').getContext('2d');
            charts.throughputTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: generateTimeLabels(24),
                    datasets: [{
                        label: 'Trains per Hour',
                        data: generateMockThroughputData(24),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }, {
                        label: 'AI Optimized',
                        data: generateMockOptimizedData(24),
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Trains per Hour'
                            }
                        }
                    }
                }
            });
        }
        
        function initializePunctualityChart() {
            const ctx = document.getElementById('punctualityChart').getContext('2d');
            charts.punctuality = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['On Time (±5min)', 'Minor Delay (5-15min)', 'Major Delay (15-30min)', 'Critical Delay (>30min)'],
                    datasets: [{
                        label: 'Number of Trains',
                        data: [156, 23, 8, 3],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        function initializeAIPerformanceChart() {
            const ctx = document.getElementById('aiPerformanceChart').getContext('2d');
            charts.aiPerformance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: generateTimeLabels(24),
                    datasets: [{
                        label: 'Prediction Accuracy (%)',
                        data: generateMockAIAccuracyData(24),
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.1,
                        yAxisID: 'y'
                    }, {
                        label: 'Response Time (ms)',
                        data: generateMockResponseTimeData(24),
                        borderColor: 'rgb(255, 159, 64)',
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        tension: 0.1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Accuracy (%)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Response Time (ms)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }
        
        function initializeConflictResolutionChart() {
            const ctx = document.getElementById('conflictResolutionChart').getContext('2d');
            charts.conflictResolution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Prevented', 'Resolved', 'Pending'],
                    datasets: [{
                        data: [42, 18, 2],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(23, 162, 184, 0.8)',
                            'rgba(255, 193, 7, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        async function loadAuditTrail() {
            try {
                const response = await window.authManager.makeAuthenticatedRequest('/api/traffic-control/audit-trail?limit=10');
                
                if (response) {
                    const data = await response.json();
                    displayAuditTrail(data.data || []);
                } else {
                    // Display mock data for demonstration
                    displayMockAuditTrail();
                }
                
            } catch (error) {
                console.error('Audit trail loading error:', error);
                displayMockAuditTrail();
            }
        }
        
        function displayAuditTrail(auditEntries) {
            const container = document.getElementById('auditTrailContainer');
            
            if (!auditEntries || auditEntries.length === 0) {
                container.innerHTML = '<p class="text-muted">No recent activities</p>';
                return;
            }
            
            container.innerHTML = auditEntries.map(entry => `
                <div class="audit-entry ${entry.type || 'success'}">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>${entry.action || 'System Activity'}</strong>
                            <p class="mb-1">${entry.description || entry.message}</p>
                            <small class="text-muted">
                                <i class="fas fa-user"></i> ${entry.user || 'System'} | 
                                <i class="fas fa-clock"></i> ${new Date(entry.timestamp).toLocaleString()}
                            </small>
                        </div>
                        <div>
                            <span class="badge bg-${entry.type === 'success' ? 'success' : entry.type === 'warning' ? 'warning' : 'info'}">
                                ${entry.status || 'Completed'}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function displayMockAuditTrail() {
            const mockData = [
                {
                    type: 'success',
                    action: 'AI Optimization Completed',
                    message: 'Section SECT_001 optimized successfully - 15% improvement in throughput',
                    user: 'AI System',
                    timestamp: new Date(Date.now() - 5 * 60 * 1000),
                    status: 'Completed'
                },
                {
                    type: 'info',
                    action: 'Controller Decision',
                    message: 'Train 12951 precedence accepted as per AI recommendation',
                    user: 'Traffic Controller',
                    timestamp: new Date(Date.now() - 15 * 60 * 1000),
                    status: 'Applied'
                },
                {
                    type: 'warning',
                    action: 'Conflict Detected',
                    message: 'Potential crossing conflict between trains 12615 and 20001 - AI resolution in progress',
                    user: 'AI System',
                    timestamp: new Date(Date.now() - 25 * 60 * 1000),
                    status: 'Resolved'
                },
                {
                    type: 'success',
                    action: 'Performance Milestone',
                    message: 'System achieved 96.7% punctuality rate - highest this month',
                    user: 'System Monitor',
                    timestamp: new Date(Date.now() - 45 * 60 * 1000),
                    status: 'Achievement'
                }
            ];
            
            displayAuditTrail(mockData);
        }
        
        function setTimeRange(range) {
            currentTimeRange = range;
            
            // Update active button
            document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Reload data
            loadPerformanceData();
            showNotification(`Analysis period updated to ${range}`, 'info');
        }
        
        function loadFullAuditTrail() {
            window.open('/audit-trail.html', '_blank');
        }
        
        function goBack() {
            window.location.href = '/admin.html';
        }
        
        // Utility functions for generating mock data
        function generateTimeLabels(hours) {
            const labels = [];
            const now = new Date();
            for (let i = hours - 1; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 60 * 60 * 1000);
                labels.push(time.getHours() + ':00');
            }
            return labels;
        }
        
        function generateMockThroughputData(points) {
            return Array.from({length: points}, () => Math.floor(Math.random() * 20) + 15);
        }
        
        function generateMockOptimizedData(points) {
            return Array.from({length: points}, (_, i) => {
                const base = Math.floor(Math.random() * 20) + 15;
                return base + Math.floor(Math.random() * 8) + 2; // Optimized is generally higher
            });
        }
        
        function generateMockAIAccuracyData(points) {
            return Array.from({length: points}, () => Math.floor(Math.random() * 8) + 92);
        }
        
        function generateMockResponseTimeData(points) {
            return Array.from({length: points}, () => Math.floor(Math.random() * 100) + 50);
        }
    </script>
</body>
</html>